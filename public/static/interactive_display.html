<!doctype html>
<html>
	<style>
		#host_div
		{
			left: 0px;
			top: 0px;
			width: 100%;
			height: 100%;
			position:relative;
		}
		#canvas_fg1
		{
			position:absolute;
			left: 0px;
			top: 0px;
			z-index: 2;
		}
		#canvas_fg2
		{
			position:absolute;
			left: 0px;
			top: 0px;
			z-index: 3;
			
			mix-blend-mode: darken;
		}
		#img_layer1
		{
			position:absolute;
			left: 0px;
			top: 0px;
			z-index: 1;
		}
		#img_bg
		{
			position:absolute;
			left: 0px;
			top: 0px;
			opacity: 1.0;
			z-index: -1;
		}
		
		#video
		{
			position:absolute;
			left: 0px;
			top: 0px;
			opacity: 1;
			z-index: 0;
		}
	</style>
	<head>
		<title>AVGdemo</title>
		<script src="http://code.jquery.com/jquery-1.11.1.js"></script>
		<script src="/socket.io/socket.io.js"></script>
		<script src="js/animateobject.js"></script>
	</head>
	<body>
		<div id = "host_div" onclick="onClick(event)">
		<img id="img_layer2_id1" src = "image/VG-P3_Camera.png" hidden = "true" />
		<img id="img_layer1" src = "image/VG_corners.png" hidden = "true"/>
		<<img id = "img_bg" src = "image/VG_BG.png">
		<canvas id="canvas_fg1" > </canvas>
		<canvas id="canvas_fg2" > </canvas>
	
		</div>
		<script>
			var objects_layer1 = [];
			var objects_layer2 = [];
			function getInteractiveLayers()
			{
				socket.emit('get interactiveLayers');
			}
			function getRandomColor() {
				var letters = '0123456789ABCDEF'.split('');
				var color = '#';
				for (var i = 0; i < 6; i++ ) {
					color += letters[Math.floor(Math.random() * 16)];
				}
				return color;
			}
			
			var socket = io();			
			var sectionObj = new Object();
		
			var img_bg = document.getElementById('img_bg');
			var img_layer1 = document.getElementById('img_layer1');
			var	img_layer2_id1 = document.getElementById('img_layer2_id1');
			
			var ctx_fg1 = canvas_fg1.getContext('2d');
			var ctx_fg2 = canvas_fg2.getContext('2d');
			
			var objectnum;
			
			var width = img_bg.width;
			var height = img_bg.height;
			
			canvas_fg1.width = width;
			canvas_fg1.height = height;
			canvas_fg2.width = width;
			canvas_fg2.height = height;
			
			//
			$(document).ready(function()
			{
				getInteractiveLayers();
				socket.on('send interactivelayers', function(msg)
				{
					sectionObj = msg;
					objectnum = 0;
					var currIndex = 0;
					while(currIndex < sectionObj.indexArray.length)
					{
						currIndex += 1;
						var startIndex = sectionObj.indexArray[currIndex];
						currIndex += 1;
						var endIndex = sectionObj.indexArray[currIndex];
			
						interactive_poly = [];
						for(var i = startIndex; i < endIndex - 2; i += 2)
						{
							var p = new jsPoint(sectionObj.sectionArray[i], sectionObj.sectionArray[i+1]);
							interactive_poly.push(p);
						}
						var p = new jsPoint(sectionObj.sectionArray[endIndex-2], sectionObj.sectionArray[endIndex-1]);
						interactive_poly.push(p);
						objects_layer1[objectnum] = new indisObject(interactive_poly, img_layer1, false);
						
						objectnum += 1;
						
						if (sectionObj.indexArray[currIndex+1] == -2)
						{
							currIndex += 2;
						}
					}
				});
				
				interactive_poly = [];
				interactive_poly.push(new jsPoint(0, 0));
				interactive_poly.push(new jsPoint(669, 0));
				interactive_poly.push(new jsPoint(669,332));
				interactive_poly.push(new jsPoint(0, 332));
				
				objects_layer2[0] = new indisObject(interactive_poly, img_layer2_id1, false);
				//objects_layer2[0].renderImage(ctx_fg1, canvas_fg1, 0, 0, 669, 332);
				animate();
			});
			
			function animate () {
				requestAnimationFrame (animate);
				for (var i = 0; i < objectnum; i++)
				{
					objects_layer1[i].animate();
				}
				ctx_fg1.clearRect(0, 0, canvas_fg1.width, canvas_fg1.height);
				var test = 0;
				for (var i = 0; i < objectnum; i++)
				{
					if (objects_layer1[i].live)
					{
						test += 1;
						objects_layer1[i].renderFrameInMaskRect(ctx_fg1);
					}
				}
				ctx_fg1.strokeRect(0, 0, 300, 300);

			
				//
				objects_layer2[0].animate();
				ctx_fg2.clearRect(0, 0, canvas_fg2.width, canvas_fg2.height);
				if (objects_layer2[0].live)
				{
					objects_layer2[0].renderFrameInImageRect(ctx_fg2);
				}
				ctx_fg2.strokeRect(200, 200, 400, 400);
			}

			
			function onClick(event) 
			{
				var x = event.clientX;
				var y = event.clientY;
				var pt = new jsPoint(x, y);
				
				ctx_fg1.beginPath();
				ctx_fg1.arc(x, y, 5, 0, 2 * Math.PI, false);
				ctx_fg1.fillStyle = 'blue';
				ctx_fg1.fill();
	
				ctx_fg1.closePath();

				for (var i = 0; i < objectnum; i++)
				{
					if(objects_layer1[i].testObjectClick(pt))
					{
						objects_layer1[i].breath(70);
						//objects_layer1[i].renderImageInMask(ctx_fg2);
						//objects_layer1[0].renderImageInMask(ctx_fg2);
						if (i == 5)
						{
							objects_layer2[0].easeIn(100);
							objects_layer2[0].transFromRectToRect(0, 0, 669, 0, 200, 200, 669, 362, 30);
						}
					}
				}
			}
			
		</script>
	</body>
</html>
