<!doctype html>
<html>
	<style>
		#host_div
		{
			position: absolute;
			left: 0px;
			top: 0px;
			width: 1280px;
			height: 720px;
		}
		video
		{
			position:absolute;
			left: 0px;
			top: 0px;
			z-index: 1;
		}
		#canvas_time
		{
			position:absolute;
			left: 0px;
			top: 0px;
			z-index: 3;
			alpha: 0;
			opacity: 0.3;
		}
		#canvas_block
		{
			position:absolute;
			left: 0px;
			top: 0px;
			z-index: 12;
			alpha: 0.3;
			mix-blend-mode: overlay;
		}
		#canvas_subtitle
		{
			position:absolute;
			left: 0px;
			top: 0px;
			z-index: 10;
			opacity: 1;
			mix-blend-mode: normal;
		}
		#canvas_light
		{
			position:absolute;
			left: 0px;
			top: 0px;
			z-index: 2;
			opacity: 1;
			mix-blend-mode: overlay;
		}
		#toggle
		{
			position:absolute;
			left: 1223px;
			top: 680px;
			z-index: 4;
			cursor: pointer;
		}
		.img
		{
			float: left;
		}
	</style>
	<head>
		<title>AVGdemo</title>
		<link href="/bootstrap/css/bootstrap.min.css" rel="stylesheet">
		<script src="/js/jquery-1.8.3.min.js"></script>
		<script src="/bootstrap/js/bootstrap.min.js"></script>
		<script src="/socket.io/socket.io.js"></script>
		<script src = "/js/animateobject.js"></script>
	</head>
	<body>
		<ul id="messages"></ul>
		<div id = "host_div">
		<video id="video" src="/video/youfromstar1.mp4" controls></video>
		<canvas id="canvas_time" width="1280px" height="690px"></canvas>
		<canvas id="canvas_block" onclick="onCanvasClick(event)" width="1280px" height="720px"></canvas>
		<button id="toggle" type="button" class="btn btn-default btn-lg">
			<span class="glyphicon glyphicon-hand-up"></span>
		</button>
		<img id="imgLight" class="img" src="/image/SC-Jacket.png"/>
		<canvas id="canvas_light" > </canvas>
		<!-- -->
		<canvas id="canvas_subtitle" > </canvas>
		<img id="img_layer2_id0" src = "image/zm-3.png" hidden = "true" />
		<img id="img_layer2_id1" src = "image/zm-1.png" hidden = "true" />
		<img id="img_layer2_id2" src = "image/chanel.png" hidden = "true" />
		<img id="img_layer2_id3" src = "image/chanel-logo.png" hidden = "true" />
		<div>
		<!-- -->
		<script>
			var host_div = document.getElementById('host_div');
			var video=document.getElementById('video');
			var canvas_time=document.getElementById('canvas_time');
			var ctx_time=canvas_time.getContext('2d');
			var canvas_block=document.getElementById('canvas_block');
			var ctx_block=canvas_block.getContext('2d');
			var imgLight=document.getElementById('imgLight');
			var canvas_light=document.getElementById('canvas_light');
			var ctx_light = canvas_light.getContext('2d');
			var canvas_subtitle = document.getElementById('canvas_subtitle');
			var ctx_subtitle = canvas_subtitle.getContext('2d');
			var socket = io();			
			
			var sectionObj = new Object();
			
			var yOffset = 7;
			
			var stepY = 0;
			var maxY = 400;
			var lightWidth = 322;
			var lightX = 470;
			var lightY = 320;
			var lightHeight = 77;
			
			var startTime1 = 912;
			var startTime2 = 913;
			var imgAnimationSetFlag = 0;
			var imgSetFlag = 1;
			
			//
			var testtime = 13;
			var subtitleBegin = false;
			var subtitleOn = false;
			var subtitleEnd = false;
			var subtitleOff = false;
			var subtileStartime = 0;
			
			var subtitleObject;
			var img_subtile;
			canvas_subtitle.width = 1280;
			canvas_subtitle.height = 690;
			//
			var objectLight;
			canvas_light.width = 1280;
			canvas_light.height = 690;
			//
			function getLocation()
			{
				socket.emit('get location');
			}
			function judgeTime(t)
			{
				var timePerFrame = 1 / sectionObj.fps;
				for(var i = 0; i < sectionObj.sectionNumber; i++)
				{
					if (t >= sectionObj.timeArray[i] * timePerFrame && t <= sectionObj.timeArray[i+1] * timePerFrame)
					{
						return  -1 * (i + 1);
					}
				}
				return 0;
			}
			function onCanvasClick(event) 
			{
				var blockData = ctx_block.getImageData(0, 0, canvas_block.width, canvas_block.height);
				var x = event.clientX;
				var y = event.clientY;
				if(blockData.data[(y * canvas_block.width + x) * 4] == 255 && blockData.data[(y * canvas_block.width + x) * 4 + 1] == 255 && blockData.data[(y * canvas_block.width + x) * 4 + 2] == 255)
				{
					video.pause();
					window.open("http://item.taobao.com/item.htm?spm=a230r.1.14.18.W7hLca&id=36806788882&ns=1#detail");
					//window.open("detail");
				}
			}
			
			function animate () 
			{
				requestAnimationFrame (animate);
				objectLight.animate();
				ctx_light.clearRect(0, 0, canvas_light.width, canvas_light.height);
				if (objectLight.live)
				{
					objectLight.renderFrameInImageRect(ctx_light);
				}
				ctx_subtitle.clearRect(0, 0, canvas_subtitle.width, canvas_subtitle.height);
				subtitleObject.animate();
				if(subtitleObject.live)
				{
					subtitleObject.renderFrameInImageRect(ctx_subtitle);
				}
			}
			
			$(document).ready(function()
			{
				getLocation();
				$("#toggle").click(function(){
					$("#canvas_block").toggle();
				});
				socket.on('send location', function(msg)
				{
					sectionObj = msg;
				});
				$("#canvas_block").toggle();
				interactive_poly = [];
				interactive_poly.push(new jsPoint(0, 0));
				interactive_poly.push(new jsPoint(669, 0));
				interactive_poly.push(new jsPoint(669,332));
				interactive_poly.push(new jsPoint(0, 332));
			
				objectLight = new indisObject(interactive_poly, imgLight, false);
				//
				img_subtile = document.getElementById("img_layer2_id0");	
				subtitleObject = new indisObject(null, img_subtile, false);
				
				var img_underneath = document.getElementById("img_layer2_id1");
				var underneathObject = new indisObject(null, img_underneath, false);
				subtitleObject.appendChildObject(underneathObject, "independentChild");
				
				var img_channel = document.getElementById("img_layer2_id2");
				var channelObject = new indisObject(null, img_channel, false);
				subtitleObject.appendChildObject(channelObject, "independentChild");
				//
				animate();
			});
			
			var time = video.currentTime;
			var clearFlag = 0;
			var interval;
			video.addEventListener('play', function() 
			{
				clearInterval(interval);
				interval = setInterval(drawFrame, 1 / sectionObj.fps * 1000)
			}, false);
			
			function drawFrame()
			{
				time = video.currentTime;
				ctx_time.fillStyle = "blue";
				ctx_time.font = '60pt Calibri';
				ctx_time.clearRect(0, 0, canvas_time.width, canvas_time.height);
				ctx_time.fillText(time, 600, 100);
				//
				if (time <= startTime2 && time >= startTime1 && imgAnimationSetFlag == 0)
				{
					objectLight.easeIn(10);
					objectLight.transFromRectToRect(340, 387, 207, 74, 661, 403, 207, 74, 30);
					imgAnimationSetFlag = 1;
					imgSetFlag = 0;
				}
				else
				{
					if ((time >= startTime2 || time < startTime1) && imgSetFlag == 0)
					{
						imgSetFlag = 1;
						imgAnimationSetFlag = 0;
					}	
				}
				//
				if (subtitleOn && time >= subtileStartime + 10)
				{
					subtitleEnd = true;
				}
				if (subtitleEnd && !subtitleOff)
				{
					subtitleObject.easeOut(50);
					subtitleEnd = false;
					subtitleOff = true;
				}
				
				if (time >= testtime - 10 && time <= testtime + 10 && !subtitleOn)
				{
					subtileStartime = time;
					subtitleBegin = true;
				}
				if (subtitleBegin)
				{	
					var anchor1 = new jsPoint(host_div.clientWidth - subtitleObject.imageCSSwidth - 10, host_div.clientHeight - subtitleObject.imageCSSheight - 80);
					var boardSize = new jsSize(subtitleObject.imageCSSwidth, subtitleObject.imageCSSheight);
					subtitleObject.easeIn(80);
					subtitleObject.transFromRectToRect(anchor1.x - 300, anchor1.y ,  boardSize.width + 300, boardSize.height, 
													   anchor1.x , anchor1.y,  boardSize.width, boardSize.height, 50);			
													   
					setTimeout(function()
							{
								subtitleObject.setAnimateRootPointer(1);
								subtitleObject.easeIn(80);
								subtitleObject.transFromRectToRect(anchor1.x+80, anchor1.y + 0.5*boardSize.height ,  0, 0, 
													   anchor1.x , anchor1.y,  boardSize.width, boardSize.height, 50);
								setTimeout(function()
										{
											subtitleObject.setAnimateRootPointer(0);
											subtitleObject.easeIn(120);
											subtitleObject.transFromRectToRect(anchor1.x, anchor1.y ,  boardSize.width, boardSize.height, 
													   anchor1.x , anchor1.y,  boardSize.width, boardSize.height, 50);	
											//
											subtitleObject.resetAnimateRootPointer();
										}, 600);
								//

							}, 200);
										 
					
					
					subtitleBegin = false;
					subtitleOn = true;
				}

				//
				var currentSection = judgeTime(time);
				if(currentSection != 0)
				{				
					$('#toggle').attr('disabled', false);
					ctx_block.clearRect(0, 0, canvas_block.width, canvas_block.height);
					var startIndex = sectionObj.indexArray.indexOf(currentSection) + 1;
					var endIndex = sectionObj.indexArray.indexOf(currentSection - 1);
					var cIndex = startIndex;
					for(cIndex = startIndex; cIndex < endIndex - 1; cIndex++)
					{
						var contourPointNumber = sectionObj.indexArray[cIndex + 1] - sectionObj.indexArray[cIndex];
						ctx_block.fillStyle="#00FFFF";
						ctx_block.save();
						ctx_block.beginPath();
						ctx_block.moveTo(sectionObj.sectionArray[sectionObj.indexArray[cIndex]], sectionObj.sectionArray[sectionObj.indexArray[cIndex] + 1] + yOffset);
						var i = 0;
						for(i = sectionObj.indexArray[cIndex] + 2; i < contourPointNumber + sectionObj.indexArray[cIndex]; i = i + 2)
						{
							ctx_block.lineTo(sectionObj.sectionArray[i], sectionObj.sectionArray[i+1] + yOffset);
						}
						ctx_block.closePath();
						//ctx_block.fill();
						ctx_block.clip();
						//ctx_block.drawImage(img_light, lightX, lightY + stepY, lightWidth, lightHeight);
						ctx_block.restore();
						stepY = stepY + 10;
						if(stepY > maxY)
						{
							stepY = 0;
						}
					}
				}
				else
				{
					if(clearFlag == 0)
					{
						$('#toggle').attr('disabled', true);
						ctx_block.clearRect(0, 0, canvas_block.width, canvas_block.height);
						$("#canvas_block").hide();
						clearFlag = 1;
					}
				}
			}	
		</script>
	</body>
</html>
